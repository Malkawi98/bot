<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Support Bot - Knowledge Base</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .sidebar-active { background-color: rgba(17, 24, 39, 0.8); }
        .transition-width { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">
    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="bg-gray-900 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 transition duration-200 ease-in-out z-20">
            <div class="flex items-center justify-between px-4">
                <div class="text-2xl font-semibold">
                    <span class="text-teal-400">E-Bot</span> Admin
                </div>
                <button id="closeSidebar" class="md:hidden rounded-lg focus:outline-none focus:shadow-outline p-1">
                    <i class="fas fa-times text-white text-lg"></i>
                </button>
            </div>
            <nav class="mt-10">
                <a href="/bot-config" class="sidebar-item flex items-center py-2 px-4 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg">
                    <i class="fas fa-cog mr-3"></i>Bot Configuration
                </a>
                <a href="/knowledge-base" class="sidebar-item flex items-center py-2 px-4 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg sidebar-active">
                    <i class="fas fa-book mr-3"></i>Knowledge Base
                </a>
                <a href="/product-management" class="sidebar-item flex items-center py-2 px-4 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg">
                    <i class="fas fa-shopping-cart mr-3"></i>Product Management
                </a>
                <a href="/coupon-management" class="sidebar-item flex items-center py-2 px-4 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg">
                    <i class="fas fa-tag mr-3"></i>Coupon Management
                </a>
                <a href="/langgraph-chat-test" class="sidebar-item flex items-center py-2 px-4 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg">
                    <i class="fas fa-project-diagram mr-3"></i>LangGraph Chat
                </a>
                <a href="/" class="flex items-center py-2 px-4 text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg mt-10">
                    <i class="fas fa-home mr-3"></i>Back to Home
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-x-hidden overflow-y-auto">
            <!-- Top Navigation -->
            <header class="bg-white shadow-md py-4 px-4">
                <div class="flex items-center justify-between">
                    <button id="openSidebar" class="md:hidden rounded-lg focus:outline-none focus:shadow-outline p-1">
                        <i class="fas fa-bars text-gray-800 text-lg"></i>
                    </button>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-700">Admin User</span>
                        <img class="h-8 w-8 rounded-full" src="https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff" alt="Admin">
                    </div>
                </div>
            </header>

            <!-- Knowledge Base Content -->
            <div id="knowledge-content" class="container mx-auto px-4 py-6">
                <h1 class="text-2xl font-semibold text-gray-800 mb-6">Knowledge Base Management</h1>
                
                <!-- Main content in a single column layout -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Import knowledge section (at the top) -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Import Knowledge</h2>
                        
                        <!-- Import from URL -->
                        <div class="mb-6">
                            <h3 class="font-medium text-gray-700 mb-2">Import from URL</h3>
                            <div class="flex">
                                <input type="text" id="import-url" placeholder="https://example.com/docs" class="flex-1 px-4 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button id="import-url-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r-lg">
                                    Import
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Imported content will be automatically added to the vector store.</p>
                        </div>
                        

                        
                        <!-- Upload file -->
                        <div>
                            <h3 class="font-medium text-gray-700 mb-2">Upload File</h3>
                            <div id="file-drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                                <input type="file" id="file-upload" class="hidden" accept=".pdf,.docx,.txt,.md,.csv">
                                <label for="file-upload" class="cursor-pointer block w-full h-full">
                                    <div class="flex flex-col items-center justify-center">
                                        <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"></i>
                                        <p class="text-gray-700 mb-1">Drag & drop a file here, or click to browse</p>
                                        <p class="text-xs text-gray-500">Supported formats: PDF, DOCX, TXT, MD, CSV</p>
                                    </div>
                                </label>
                                <p id="file-name" class="mt-2 text-sm text-blue-600 hidden"></p>
                                <div class="mt-3 flex space-x-2 justify-center">
                                    <button id="upload-file-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg hidden">
                                        <i class="fas fa-upload mr-1"></i> Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Knowledge entries section (below import) -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Knowledge Entries</h2>
                            <button id="reset-vector-store-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm flex items-center">
                                <i class="fas fa-trash-alt mr-1"></i> Reset Vector Store
                            </button>
                        </div>
                        
                        <!-- Knowledge entries list -->
                        <div id="knowledge-entries-list" class="space-y-4">
                            {% if entries and entries|length > 0 %}
                                <div class="text-sm text-gray-600 mb-3">Total entries: {{ entries|length }}</div>
                                
                                {% for entry in entries %}
                                    <div class="entry bg-white rounded-lg shadow-sm border p-4 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start">
                                        <h3 class="font-semibold text-lg">Entry #{{ entry.id }}</h3>
                                        <div class="flex space-x-1">
                                            {% if entry.language == 'ar' %}
                                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Arabic (العربية)</span>
                                            {% else %}
                                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">English</span>
                                            {% endif %}
                                            <button class="delete-entry-btn text-red-500 hover:text-red-700" data-id="{{ entry.id }}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <p class="text-gray-700 truncate">{{ entry.text|truncate(150) }}</p>
                                    </div>
                                    <div class="mt-3 flex justify-between items-center">
                                        <button class="view-entry-btn text-blue-500 hover:text-blue-700" data-id="{{ entry.id }}">
                                            <i class="fas fa-eye mr-1"></i> View Full Content
                                        </button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-6 bg-gray-50 rounded-lg border border-gray-200">
                                    <i class="fas fa-database text-gray-400 text-3xl mb-2"></i>
                                    <h3 class="text-lg font-semibold text-gray-700 mb-2">No entries found in the vector store</h3>
                                    <p class="text-gray-600 mb-4">Your knowledge base appears to be empty. Add some content to get started.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Vector Store Search Section (hidden by default) -->
                    <div id="vector-search-section" class="bg-white rounded-lg shadow-md p-6 hidden">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Vector Store Search</h2>
                        <div class="mb-4">
                            <div class="flex flex-col space-y-2">
                            <div class="flex">
                                <input id="vector-search-input" class="shadow appearance-none border rounded-l w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="text" placeholder="Search the vector store...">
                                <button id="execute-search-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-r focus:outline-none focus:shadow-outline">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center text-sm text-gray-600">
                                    <input type="checkbox" id="search-all-languages" class="form-checkbox mr-2" checked>
                                    Search across all languages
                                </label>
                                <div id="language-filter" class="ml-4 flex items-center" style="display: none;">
                                    <label class="mr-2 text-sm text-gray-600">Filter by:</label>
                                    <select id="search-language" class="text-sm border rounded py-1 px-2">
                                        <option value="en">English</option>
                                        <option value="ar">Arabic (العربية)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        </div>
                        <div id="vector-search-results" class="mt-4 space-y-4">
                            <!-- Search results will be displayed here -->
                        </div>
                        <div class="mt-6">
                            <h3 class="font-semibold text-gray-700 mb-2">Add New Content to Vector Store</h3>
                            <textarea id="vector-content-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="4" placeholder="Enter content to add to the vector store..."></textarea>
                            
                            <div class="mt-2 flex items-center">
                                <label class="mr-2 text-gray-700 text-sm font-bold">Language:</label>
                                <select id="content-language" class="shadow border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="en">English</option>
                                    <option value="ar">Arabic (العربية)</option>
                                </select>
                                
                                <button id="add-to-vector-store-btn" class="ml-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                    <i class="fas fa-plus mr-1"></i> Add to Vector Store
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div id="add-source-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Add Knowledge Source</h2>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="add-source-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="source-name">
                        Source Name
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="source-name" type="text" placeholder="e.g., Product Warranties">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="source-description">
                        Description
                    </label>
                    <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="source-description" rows="3" placeholder="Brief description of this knowledge source"></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Source Type
                    </label>
                    <div class="mt-2">
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio" name="source-type" value="manual" checked>
                            <span class="ml-2">Manual Entries</span>
                        </label>
                    </div>
                    <div class="mt-2">
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio" name="source-type" value="url">
                            <span class="ml-2">URL Import</span>
                        </label>
                    </div>
                    <div class="mt-2">
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio" name="source-type" value="file">
                            <span class="ml-2">File Import</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex items-center justify-end">
                    <button type="button" id="cancel-add-source" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline mr-2">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Add Source
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Mobile sidebar toggle
        document.getElementById('openSidebar').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
        });
        
        document.getElementById('closeSidebar').addEventListener('click', function() {
            document.getElementById('sidebar').classList.add('-translate-x-full');
        });
        
        // Entry search functionality
        const entrySearch = document.getElementById('entry-search');
        if (entrySearch) {
            entrySearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const entries = document.querySelectorAll('#knowledge-entries-list .entry');
                
                entries.forEach(entry => {
                    const title = entry.querySelector('h3').textContent.toLowerCase();
                    const content = entry.querySelector('p').textContent.toLowerCase();
                    const tags = Array.from(entry.querySelectorAll('.tag')).map(tag => tag.textContent.toLowerCase());
                    
                    const isMatch = title.includes(searchTerm) || content.includes(searchTerm) || tags.some(tag => tag.includes(searchTerm));
                    entry.style.display = isMatch ? 'block' : 'none';
                });
            });
        }
        
        // Load all entries from vector store
        async function loadVectorStoreEntries() {
            const entriesContainer = document.getElementById('knowledge-entries-list');
            console.log('Starting to load vector store entries...');
            
            // Show loading indicator
            entriesContainer.innerHTML = `
                <div id="knowledge-entries-loading" class="text-center py-8">
                    <i class="fas fa-circle-notch fa-spin text-blue-500 text-3xl mb-3"></i>
                    <p class="text-gray-600">Loading knowledge entries...</p>
                </div>
            `;
            
            try {
                console.log('Fetching vector store entries...');
                // Fetch all entries from vector store API
                const response = await fetch('/api/v1/vector-store/all');
                
                if (!response.ok) {
                    throw new Error(`Failed to load knowledge entries: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Received vector store data:', data);
                
                // Check for any error messages
                if (!data.success && data.message) {
                    console.error('Error from API:', data.message);
                    throw new Error(data.message);
                }
                
                // Display knowledge entries
                if (data.success && data.entries && data.entries.length > 0) {
                    entriesContainer.innerHTML = `<div class="text-sm text-gray-600 mb-3">Total entries: ${data.count}</div>`;
                    
                    data.entries.forEach((entry, index) => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'bg-white rounded-lg shadow-sm border p-4 hover:shadow-md transition-shadow';
                        
                        // Check if entry.text exists to avoid errors
                        const entryText = entry.text || entry.content || '';
                        
                        // Truncate text if it's too long
                        const truncatedText = entryText.length > 150 ? entryText.substring(0, 150) + '...' : entryText;
                        
                        entryElement.innerHTML = `
                            <div>
                                <h3 class="font-medium text-gray-800 flex items-center">
                                    <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                                    Entry #${entry.id || index + 1}
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">${truncatedText}</p>
                            </div>
                        `;
                        
                        // Add click event to show full text in a modal
                        entryElement.addEventListener('click', () => {
                            showEntryModal(entry);
                        });
                        
                        entriesContainer.appendChild(entryElement);
                    });
                    
                    // Add a refresh button
                    const refreshButton = document.createElement('button');
                    refreshButton.className = 'mt-4 bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 flex items-center justify-center w-full';
                    refreshButton.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Refresh Entries';
                    refreshButton.addEventListener('click', () => loadVectorStoreEntries());
                    entriesContainer.appendChild(refreshButton);
                    
                } else {
                    entriesContainer.innerHTML = `
                        <div class="text-center py-8 bg-gray-50 rounded-lg border border-gray-200">
                            <i class="fas fa-database text-gray-400 text-3xl mb-3"></i>
                            <p class="text-gray-600 mb-4">No knowledge entries found.</p>
                            <p class="text-sm text-gray-500">Import knowledge from a URL or upload a file to get started.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading knowledge entries:', error);
                
                entriesContainer.innerHTML = `
                    <div class="text-center py-8 bg-red-50 rounded-lg border border-red-200">
                        <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                        <p class="text-red-600 mb-2">Error loading knowledge entries</p>
                        <p class="text-sm text-red-500">${error.message}</p>
                        <button id="retry-load-btn" class="mt-4 bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200">
                            <i class="fas fa-redo mr-2"></i> Retry
                        </button>
                    </div>
                `;
                
                // Add retry button functionality
                document.getElementById('retry-load-btn')?.addEventListener('click', loadVectorStoreEntries);
                
                showNotification('Error loading knowledge entries: ' + error.message, 'error');
            }
        }
        
        // Show entry details in a modal
        function showEntryModal(entry) {
            // Create modal element
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'entry-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden">
                    <div class="flex justify-between items-center border-b p-4">
                        <h3 class="text-xl font-semibold">Knowledge Entry #${entry.id}</h3>
                        <button class="text-gray-500 hover:text-gray-700" id="close-modal">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="p-4 overflow-y-auto max-h-[calc(80vh-8rem)]">
                        <p class="whitespace-pre-wrap">${entry.text}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking the close button or outside the modal
            document.getElementById('close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // Import URL
        const importUrlBtn = document.getElementById('import-url-btn');
        if (importUrlBtn) {
            importUrlBtn.addEventListener('click', async () => {
                const urlInput = document.getElementById('import-url');
                if (!urlInput) return;
                
                const url = urlInput.value.trim();
                
                if (!url) {
                    showNotification('Please enter a valid URL', 'error');
                    return;
                }
                
                try {
                    // Show loading state
                    const originalBtnText = importUrlBtn.innerHTML;
                    importUrlBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
                    importUrlBtn.disabled = true;
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('url', url);
                    
                    // Call the RAG context API
                    const response = await fetch('/api/v1/rag/context', {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Parse the response JSON even if it's an error
                    const responseData = await response.json();
                    
                    if (!response.ok) {
                        // Get the error message from the response if available
                        const errorMessage = responseData.detail || 'Failed to import URL';
                        throw new Error(errorMessage);
                    }
                
                    // Reset button
                    importUrlBtn.innerHTML = originalBtnText;
                    importUrlBtn.disabled = false;
                    
                    // Show success message
                    showNotification('URL imported successfully');
                    urlInput.value = '';
                    
                    // Refresh vector store entries
                    setTimeout(() => {
                        loadVectorStoreEntries();
                    }, 1000); // Give the server a moment to process the data
                    
                } catch (error) {
                    console.error('Error importing URL:', error);
                    importUrlBtn.innerHTML = '<i class="fas fa-external-link-alt mr-1"></i> Import';
                    importUrlBtn.disabled = false;
                    showNotification('Error importing URL: ' + error.message, 'error');
                }
            });
        }
        
        // File upload handling with drag and drop
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('file-upload');
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop area when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        fileDropArea.addEventListener('drop', handleDrop, false);
        
        // Handle file selection via input
        fileInput.addEventListener('change', handleFiles, false);
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            fileDropArea.classList.add('border-blue-500');
            fileDropArea.classList.add('bg-blue-50');
        }
        
        function unhighlight() {
            fileDropArea.classList.remove('border-blue-500');
            fileDropArea.classList.remove('bg-blue-50');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                fileInput.files = files;
                handleFiles();
            }
        }
        
        function handleFiles() {
            const file = fileInput.files[0];
            if (file) {
                const fileNameDiv = document.getElementById('file-name');
                fileNameDiv.textContent = `Selected file: ${file.name}`;
                fileNameDiv.classList.remove('hidden');
                
                // Show both buttons when a file is selected
                document.getElementById('upload-file-btn').classList.remove('hidden');
                document.getElementById('process-import-btn').classList.remove('hidden');
            }
        }
        
        // Upload file button handling
        document.getElementById('upload-file-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file to upload', 'error');
                return;
            }
            
            // Show loading state
            const uploadBtn = document.getElementById('upload-file-btn');
            const originalUploadText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
            uploadBtn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload the file to the server
                const response = await fetch('/api/v1/vector-store/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('File uploaded successfully!');
                    // Reset the file input
                    fileInput.value = '';
                    document.getElementById('file-name').classList.add('hidden');
                    document.getElementById('upload-file-btn').classList.add('hidden');
                    document.getElementById('process-import-btn').classList.add('hidden');
                    
                    // Wait a moment for the background processing to complete
                    setTimeout(() => {
                        // Reload vector store entries to show the new content
                        loadVectorStoreEntries();
                    }, 2000); // Wait 2 seconds before refreshing
                } else {
                    showNotification(`Error uploading file: ${data.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                showNotification(`Error uploading file: ${error.message}`, 'error');
            } finally {
                // Reset button state
                uploadBtn.innerHTML = originalUploadText;
                uploadBtn.disabled = false;
            }
        });
        
        // Process and import file
        document.getElementById('process-import-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file to upload', 'error');
                return;
            }
            
            // Show loading state
            const importBtn = document.getElementById('process-import-btn');
            const originalText = importBtn.innerHTML;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
            importBtn.disabled = true;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // Use the rag/context endpoint for file processing
                const response = await fetch('/api/v1/rag/context', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process file');
                }
                
                const result = await response.json();
                
                if (result.text) {
                    // Add the extracted text to the vector store
                    const addResponse = await fetch('/api/v1/vector-store/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: result.text })
                    });
                    
                    if (!addResponse.ok) {
                        throw new Error('Failed to add content to vector store');
                    }
                    
                    const addResult = await addResponse.json();
                    
                    if (addResult.success) {
                        showNotification('File imported successfully');
                        fileInput.value = '';
                        document.getElementById('file-name').classList.add('hidden');
                        document.getElementById('upload-file-btn').classList.add('hidden');
                        document.getElementById('process-import-btn').classList.add('hidden');
                        
                        // Wait a moment for the background processing to complete
                        setTimeout(() => {
                            // Reload vector store entries to show the new content
                            loadVectorStoreEntries();
                            // Also reload knowledge sources to show updated counts
                            loadKnowledgeSources();
                        }, 2000); // Wait 2 seconds before refreshing
                    } else {
                        showNotification(addResult.message || 'Failed to add content to vector store', 'error');
                    }
                } else {
                    showNotification('No content extracted from file', 'error');
                }
            } catch (error) {
                console.error('Error importing file:', error);
                showNotification('Error importing file: ' + error.message, 'error');
            } finally {
                // Restore button state
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            }
        });
        
        // Get source form if it exists
        const sourceForm = document.getElementById('source-form');
        
        // Create a new knowledge source
        if (sourceForm) {
            sourceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const data = {
                    name: document.getElementById('source-name').value,
                    description: document.getElementById('source-description').value,
                    source_type: document.getElementById('source-type').value,
                    url: document.getElementById('source-url').value || undefined
                };
            
            try {
                const response = await fetch('/api/v1/knowledge-sources', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create knowledge source');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Knowledge source created successfully');
                    sourceModal.classList.add('hidden');
                    sourceForm.reset();
                    loadKnowledgeSources();
                } else {
                    showNotification(result.message || 'Failed to create knowledge source', 'error');
                }
                
            } catch (error) {
                console.error('Error creating knowledge source:', error);
                showNotification('Error creating knowledge source', 'error');
            }
        });
        }
        
        // Get entry form if it exists
        const entryForm = document.getElementById('entry-form');
        
        // Create a new knowledge entry
        if (entryForm) {
            entryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const tagsInput = document.getElementById('entry-tags').value;
                const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
            
                const data = {
                    source_id: document.getElementById('entry-source-id').value,
                    title: document.getElementById('entry-title').value,
                    content: document.getElementById('entry-content').value,
                    tags: tags
                };
            
                try {
                    const response = await fetch('/api/v1/knowledge-entries', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to create knowledge entry');
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('Knowledge entry created successfully');
                        entryModal.classList.add('hidden');
                        entryForm.reset();
                        loadKnowledgeEntries(selectedSourceId);
                        loadKnowledgeSources(); // Refresh sources to update entry count
                    } else {
                        showNotification(result.message || 'Failed to create knowledge entry', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error creating knowledge entry:', error);
                    showNotification('Error creating knowledge entry', 'error');
                }
            });
        }
        
        // Delete a knowledge source
        async function deleteKnowledgeSource(sourceId) {
            try {
                const response = await fetch(`/api/v1/knowledge-sources/${sourceId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete knowledge source');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Knowledge source deleted successfully');
                    loadKnowledgeSources();
                    
                    // Clear entries if the deleted source was selected
                    if (selectedSourceId === sourceId) {
                        selectedSourceId = null;
                        entriesContainer.innerHTML = '';
                        document.getElementById('entries-section').classList.add('hidden');
                    }
                } else {
                    showNotification(result.message || 'Failed to delete knowledge source', 'error');
                }
                
            } catch (error) {
                console.error('Error deleting knowledge source:', error);
                showNotification('Error deleting knowledge source', 'error');
            }
        }
        
        // Delete a knowledge entry
        async function deleteKnowledgeEntry(entryId) {
            try {
                const response = await fetch(`/api/v1/knowledge-entries/${entryId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete knowledge entry');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Knowledge entry deleted successfully');
                    loadKnowledgeEntries(selectedSourceId);
                    loadKnowledgeSources(); // Refresh sources to update entry count
                } else {
                    showNotification(result.message || 'Failed to delete knowledge entry', 'error');
                }
                
            } catch (error) {
                console.error('Error deleting knowledge entry:', error);
                showNotification('Error deleting knowledge entry', 'error');
            }
        }
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white px-4 py-2 rounded shadow-lg z-50`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Toggle URL input based on source type
        const sourceTypeSelect = document.getElementById('source-type');
        if (sourceTypeSelect) {
            sourceTypeSelect.addEventListener('change', (e) => {
                const urlField = document.getElementById('url-field');
                if (urlField) {
                    if (e.target.value === 'url') {
                        urlField.classList.remove('hidden');
                    } else {
                        urlField.classList.add('hidden');
                    }
                }
            });
        }
        
        // Initialize modal elements
        const sourceModal = document.getElementById('source-modal');
        const entryModal = document.getElementById('entry-modal');
        
        // Initialize reset button
        const resetVectorStoreBtn = document.getElementById('reset-vector-store-btn');
        if (resetVectorStoreBtn) {
            resetVectorStoreBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to reset the vector store? This will delete all embeddings and cannot be undone.')) {
                    try {
                        resetVectorStoreBtn.disabled = true;
                        resetVectorStoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Resetting...';
                        
                        const response = await fetch('/api/v1/vector-store/reset', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to reset vector store');
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showNotification('Vector store has been reset successfully');
                            // Refresh the entries list
                            loadVectorStoreEntries();
                        } else {
                            showNotification(result.message || 'Failed to reset vector store', 'error');
                        }
                    } catch (error) {
                        console.error('Error resetting vector store:', error);
                        showNotification('Error resetting vector store: ' + error.message, 'error');
                    } finally {
                        resetVectorStoreBtn.disabled = false;
                        resetVectorStoreBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> Reset Vector Store';
                    }
                }
            });
        }
        

        
        // Initialize vector search elements
        const vectorSearchBtn = document.getElementById('vector-search-btn');
        const vectorSearchSection = document.getElementById('vector-search-section');
        const executeSearchBtn = document.getElementById('execute-search-btn');
        const vectorSearchInput = document.getElementById('vector-search-input');
        const vectorSearchResults = document.getElementById('vector-search-results');
        const vectorContentInput = document.getElementById('vector-content-input');
        const addToVectorStoreBtn = document.getElementById('add-to-vector-store-btn');
        
        // Vector Store Search functionality
        if (vectorSearchBtn && vectorSearchSection) {
            vectorSearchBtn.addEventListener('click', () => {
                // Toggle vector search section
                if (vectorSearchSection.classList.contains('hidden')) {
                    vectorSearchSection.classList.remove('hidden');
                    vectorSearchBtn.classList.add('bg-blue-700');
                    vectorSearchBtn.classList.remove('bg-blue-500');
                } else {
                    vectorSearchSection.classList.add('hidden');
                    vectorSearchBtn.classList.remove('bg-blue-700');
                    vectorSearchBtn.classList.add('bg-blue-500');
                }
            });
        }
        
        // Execute vector search
        if (executeSearchBtn) {
            executeSearchBtn.addEventListener('click', executeVectorSearch);
        }
        
        if (vectorSearchInput) {
            vectorSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    executeVectorSearch();
                }
            });
        }
        
        async function executeVectorSearch() {
            if (!vectorSearchInput || !vectorSearchResults) {
                console.error('Vector search elements not found');
                return;
            }
            
            const query = vectorSearchInput.value.trim();
            if (!query) {
                showNotification('Please enter a search query', 'error');
                return;
            }
            
            try {
                // Show loading indicator
                vectorSearchResults.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i> Searching vector store...</div>';
                
                // Call the API to search the vector store
                const response = await fetch(`/api/v1/vector-store/entries?query=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    throw new Error('Failed to search vector store');
                }
                
                const results = await response.json();
                
                // Display the results
                if (results.length === 0) {
                    vectorSearchResults.innerHTML = '<div class="text-center py-4 text-gray-500">No results found. Try a different query or add new content.</div>';
                    return;
                }
                
                vectorSearchResults.innerHTML = '';
                results.forEach(result => {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'bg-white rounded-lg shadow-sm border p-4 hover:shadow-md transition-shadow';
                    
                    resultCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-semibold text-lg">${result.title}</h3>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Similarity: ${(1 - result.similarity).toFixed(4)}</span>
                        </div>
                        <div class="mt-2">
                            <p class="text-gray-700">${result.content}</p>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-1">
                            ${result.tags.map(tag => `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">${tag}</span>`).join('')}
                        </div>
                    `;
                    
                    vectorSearchResults.appendChild(resultCard);
                });
                
            } catch (error) {
                console.error('Error searching vector store:', error);
                vectorSearchResults.innerHTML = `<div class="text-center py-4 text-red-500">Error: ${error.message}</div>`;
                showNotification('Error searching vector store', 'error');
            }
        }
        
        // Add content to vector store
        if (addToVectorStoreBtn && vectorContentInput) {
            addToVectorStoreBtn.addEventListener('click', async () => {
                const content = vectorContentInput.value.trim();
                if (!content) {
                    showNotification('Please enter content to add', 'error');
                    return;
                }
            
                try {
                    const language = document.getElementById('content-language').value;
                    showNotification(`Adding ${language === 'ar' ? 'Arabic' : 'English'} content to vector store...`, 'info');
                    
                    const response = await fetch('/api/v1/vector-store/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            text: content,
                            language: language
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to add content to vector store');
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('Content added to vector store successfully');
                        vectorContentInput.value = '';
                        
                        // If there's a search query, refresh the search results
                        if (vectorSearchInput && vectorSearchInput.value.trim()) {
                            executeVectorSearch();
                        }
                    } else {
                        showNotification(result.message || 'Failed to add content to vector store', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error adding content to vector store:', error);
                    showNotification('Error adding content to vector store', 'error');
                }
            });
        }
        
        // Initialize knowledge sources on page load
        async function loadKnowledgeSources() {
            console.log('Initializing knowledge sources...');
            // No need to load entries via AJAX as they are already rendered server-side
            
            // Set up event listeners for the import forms and other UI elements
            setupEventListeners();
        }
        
        // Set up event listeners for the UI elements
        function setupEventListeners() {
            // Set up event listeners for the import URL form
            document.getElementById('import-url-btn').addEventListener('click', async () => {
                const urlInput = document.getElementById('import-url');
                const url = urlInput.value.trim();
                
                if (!url) {
                    showNotification('Please enter a valid URL', 'error');
                    return;
                }
                
                try {
                    // Show loading state
                    const importBtn = document.getElementById('import-url-btn');
                    const originalBtnText = importBtn.innerHTML;
                    importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
                    importBtn.disabled = true;
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('url', url);
                    
                    // Call the RAG context API
                    const response = await fetch('/api/v1/rag/context', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to import URL');
                    }
                    
                    const data = await response.json();
                    
                    // Reset button
                    importBtn.innerHTML = originalBtnText;
                    importBtn.disabled = false;
                    
                    // Show success message
                    showNotification('URL imported successfully!');
                    urlInput.value = '';
                    
                    // Show refresh prompt
                    showRefreshPrompt();
                    
                } catch (error) {
                    console.error('Error importing URL:', error);
                    showNotification('Error importing URL: ' + error.message, 'error');
                    
                    // Reset button state
                    const importBtn = document.getElementById('import-url-btn');
                    importBtn.innerHTML = 'Import';
                    importBtn.disabled = false;
                }
            });
            
            // Set up event listeners for the file upload form
            const fileInput = document.getElementById('file-upload');
            const fileDropArea = document.getElementById('file-drop-area');
            const fileNameDisplay = document.getElementById('file-name');
            const uploadBtn = document.getElementById('upload-file-btn');
            
            // File selection event
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const fileName = fileInput.files[0].name;
                    fileNameDisplay.textContent = fileName;
                    fileNameDisplay.classList.remove('hidden');
                    uploadBtn.classList.remove('hidden');
                } else {
                    fileNameDisplay.classList.add('hidden');
                    uploadBtn.classList.add('hidden');
                }
            });
            
            // File upload button click event
            uploadBtn.addEventListener('click', async () => {
                if (!fileInput.files.length) {
                    showNotification('Please select a file to upload', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                
                // Check file extension
                const fileExt = file.name.split('.').pop().toLowerCase();
                const allowedExtensions = ['pdf', 'docx', 'txt', 'md', 'csv'];
                
                if (!allowedExtensions.includes(fileExt)) {
                    showNotification(`Unsupported file format. Allowed formats: ${allowedExtensions.join(', ')}`, 'error');
                    return;
                }
                
                try {
                    // Show loading state
                    const originalText = uploadBtn.innerHTML;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                    uploadBtn.disabled = true;
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // Call the vector store upload API
                    const response = await fetch('/api/v1/vector-store/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to upload file');
                    }
                    
                    const result = await response.json();
                    
                    // Show success message
                    showNotification('File uploaded successfully!');
                    
                    // Reset form
                    fileInput.value = '';
                    fileNameDisplay.classList.add('hidden');
                    uploadBtn.classList.add('hidden');
                    
                    // Show refresh prompt
                    showRefreshPrompt();
                    
                } catch (error) {
                    console.error('Error uploading file:', error);
                    showNotification('Error uploading file: ' + error.message, 'error');
                } finally {
                    // Restore button state
                    uploadBtn.innerHTML = 'Upload';
                    uploadBtn.disabled = false;
                }
            });
            
            // Drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileDropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                fileDropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                fileDropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                fileDropArea.classList.add('border-blue-500', 'bg-blue-50');
            }
            
            function unhighlight() {
                fileDropArea.classList.remove('border-blue-500', 'bg-blue-50');
            }
            
            fileDropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    fileInput.files = files;
                    const event = new Event('change');
                    fileInput.dispatchEvent(event);
                }
            }
        }
        
        // Check Milvus connection status
        async function checkMilvusStatus() {
            const entriesContainer = document.getElementById('knowledge-entries-list');
            const loadingElement = document.getElementById('knowledge-entries-loading');
            
            try {
                console.log('Checking Milvus connection status...');
                const response = await fetch('/api/v1/vector-store/status');
                
                if (!response.ok) {
                    throw new Error(`Failed to check Milvus status: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Milvus status:', data);
                
                // If Milvus is not connected, show error message
                if (data.connection.status !== 'connected') {
                    if (loadingElement) {
                        loadingElement.innerHTML = `
                            <div class="text-center py-6 bg-red-50 rounded-lg border border-red-200">
                                <i class="fas fa-database text-red-400 text-3xl mb-2"></i>
                                <h3 class="text-lg font-semibold text-red-700 mb-2">Vector Database Connection Error</h3>
                                <p class="text-red-600 mb-2">Cannot connect to Milvus at ${data.connection.host}:${data.connection.port}</p>
                                <p class="text-red-600 mb-4">${data.connection.status}</p>
                                <div class="text-sm text-gray-600 mb-4 bg-gray-100 p-3 rounded">
                                    <p class="font-semibold">Troubleshooting:</p>
                                    <ul class="list-disc list-inside">
                                        <li>Check if Milvus is running</li>
                                        <li>Verify environment variables (MILVUS_HOST, MILVUS_PORT)</li>
                                        <li>Check network connectivity</li>
                                    </ul>
                                </div>
                                <div class="flex justify-center">
                                    <button id="retry-connection-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                        <i class="fas fa-sync-alt mr-1"></i> Retry Connection
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Add event listener for retry button
                        document.getElementById('retry-connection-btn').addEventListener('click', checkMilvusStatus);
                        
                        // Return false to indicate connection error
                        return false;
                    }
                }
                
                // If collection doesn't exist, show message
                if (!data.collection_exists) {
                    console.log(`Collection ${data.target_collection} does not exist, will be created when adding content`);
                }
                
                // Return true to indicate successful connection
                return true;
                
            } catch (error) {
                console.error('Error checking Milvus status:', error);
                
                if (loadingElement) {
                    loadingElement.innerHTML = `
                        <div class="text-center py-6 bg-red-50 rounded-lg border border-red-200">
                            <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-2"></i>
                            <h3 class="text-lg font-semibold text-red-700 mb-2">Connection Check Failed</h3>
                            <p class="text-red-600 mb-4">${error.message}</p>
                            <div class="flex justify-center">
                                <button id="retry-connection-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                    <i class="fas fa-sync-alt mr-1"></i> Retry
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener for retry button
                    document.getElementById('retry-connection-btn').addEventListener('click', checkMilvusStatus);
                }
                
                // Return false to indicate connection error
                return false;
            }
        }
        
        // Function to show a refresh button when new data is added
        function showRefreshPrompt() {
            const entriesContainer = document.getElementById('knowledge-entries-list');
            const refreshPrompt = document.createElement('div');
            refreshPrompt.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4 text-center';
            refreshPrompt.innerHTML = `
                <p class="text-blue-700 mb-2">New data has been added to the knowledge base!</p>
                <button id="refresh-page-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh Page to See Updates
                </button>
            `;
            
            // Insert at the top of the entries container
            entriesContainer.insertBefore(refreshPrompt, entriesContainer.firstChild);
            
            // Add event listener for the refresh button
            document.getElementById('refresh-page-btn').addEventListener('click', () => {
                window.location.reload();
            });
        }
        
        // Function to show mock data when Milvus is not available
        function showMockData() {
            const entriesContainer = document.getElementById('knowledge-entries-list');
            const loadingElement = document.getElementById('knowledge-entries-loading');
            
            // Remove loading indicator if it exists
            if (loadingElement) {
                loadingElement.remove();
            }
            
            // Create mock data
            const mockData = [
                {
                    id: 'mock-1',
                    title: 'Returns Policy',
                    content: 'E-commerce returns policy: Customers can return items within 30 days of purchase for a full refund. Items must be in original condition with tags attached. Return shipping is free for defective items.',
                    tags: ['policy', 'returns', 'mock-data']
                },
                {
                    id: 'mock-2',
                    title: 'Shipping Information',
                    content: 'Standard shipping takes 3-5 business days. Express shipping is available for an additional fee and delivers within 1-2 business days. International shipping may take 7-14 business days.',
                    tags: ['shipping', 'delivery', 'mock-data']
                },
                {
                    id: 'mock-3',
                    title: 'Product Warranty',
                    content: 'All electronics come with a 1-year manufacturer warranty covering defects in materials and workmanship. Extended warranties are available for purchase separately.',
                    tags: ['warranty', 'support', 'mock-data']
                },
                {
                    id: 'mock-4',
                    title: 'Payment Methods',
                    content: 'We accept Visa, Mastercard, American Express, PayPal, and Apple Pay. All transactions are secure and encrypted. Gift cards are also available for purchase.',
                    tags: ['payment', 'checkout', 'mock-data']
                },
                {
                    id: 'mock-5',
                    title: 'Customer Support Hours',
                    content: 'Our support team is available Monday-Friday 9am-6pm EST. Weekend support is available via email only. For urgent matters, please call our 24/7 hotline.',
                    tags: ['support', 'contact', 'mock-data']
                }
            ];
            
            // Display mock data with a notice
            entriesContainer.innerHTML = `
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
                    <div class="flex">
                        <div class="py-1"><i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i></div>
                        <div>
                            <p class="font-bold">Development Mode</p>
                            <p>Showing mock data because Milvus vector database is not available. This data is not persisted.</p>
                        </div>
                    </div>
                </div>
                <div class="text-sm text-gray-600 mb-3">Total entries: ${mockData.length} (mock data)</div>
            `;
            
            // Add each mock entry
            mockData.forEach((entry) => {
                const entryElement = document.createElement('div');
                entryElement.className = 'bg-white rounded-lg shadow-sm border p-4 hover:shadow-md transition-shadow mb-3';
                
                // Add language badge
                const languageBadge = entry.language === 'ar' ? 
                    `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Arabic (العربية)</span>` : 
                    `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">English</span>`;
                
                entryElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="font-semibold text-lg">${entry.title}</h3>
                        <div class="flex space-x-1">
                            ${languageBadge}
                            <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Mock Data</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <p class="text-gray-700">${entry.content}</p>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-1">
                        ${entry.tags.map(tag => `<span class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded-full">${tag}</span>`).join('')}
                    </div>
                `;
                
                entriesContainer.appendChild(entryElement);
            });
            
            showNotification('Showing mock data for development purposes', 'success');
        }
        
        // Function to add sample data to the vector store
        async function addSampleData() {
            try {
                showNotification('Adding sample data to the knowledge base...', 'success');
                
                const sampleData = [
                    "E-commerce returns policy: Customers can return items within 30 days of purchase for a full refund. Items must be in original condition with tags attached. Return shipping is free for defective items.",
                    "Shipping information: Standard shipping takes 3-5 business days. Express shipping is available for an additional fee and delivers within 1-2 business days. International shipping may take 7-14 business days.",
                    "Product warranty: All electronics come with a 1-year manufacturer warranty covering defects in materials and workmanship. Extended warranties are available for purchase separately.",
                    "Payment methods: We accept Visa, Mastercard, American Express, PayPal, and Apple Pay. All transactions are secure and encrypted. Gift cards are also available for purchase.",
                    "Customer support hours: Our support team is available Monday-Friday 9am-6pm EST. Weekend support is available via email only. For urgent matters, please call our 24/7 hotline."
                ];
                
                // Add each sample data item to the vector store
                for (const text of sampleData) {
                    await fetch('/api/v1/vector-store/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text })
                    });
                }
                
                showNotification('Sample data added successfully!', 'success');
                
                // Reload the vector store entries
                loadVectorStoreEntries();
                
            } catch (error) {
                console.error('Error adding sample data:', error);
                showNotification('Error adding sample data: ' + error.message, 'error');
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadKnowledgeSources);
    </script>
</body>
</html>
